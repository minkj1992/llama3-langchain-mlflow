# https://gist.github.com/davidcjw/1615ee5169d25c6e19785d955c49f956
FROM continuumio/miniconda3 as BUILD

WORKDIR /app

# Create the environment
COPY conda.yml .
RUN conda env create -f conda.yml

# Install conda-pack
RUN conda install -c conda-forge conda-pack

# Use conda-pack to create a standalone env in /venv
RUN conda-pack -n yfinance -o /tmp/env.tar && \
    mkdir /venv && cd /venv && tar xf /tmp/env.tar && \
    rm /tmp/env.tar

# Put venv in same path it'll be in the final image
RUN /venv/bin/conda-unpack

# This is the runtime-stage image
# Use Debian as the base image since the conda env also includes Python
FROM debian:buster AS runtime

WORKDIR /app

# Copy /venv from build stage
COPY --from=build /venv /venv

# Copy stockM folder and .env and config.yml
COPY ./app /app

# Expose the FastAPI port
EXPOSE 8000

# Start Gunicorn when the container launches
CMD ["gunicorn", "app.main:app", "--reload", "--log-level", "debug", "--workers", "1"]
